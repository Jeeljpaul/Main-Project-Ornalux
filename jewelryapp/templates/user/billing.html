{% load static %}
{% include 'user/trial.html' %}
<style>
    /* Basic styling */
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
        font-family: 'Poppins', sans-serif;
        color: #2d3436;
    }
    
    .container {
        max-width: 900px;
        padding: 30px;
    }
    
    h2 {
        color: #2a5298;
        text-align: center;
        margin-bottom: 30px;
        font-weight: 700;
        position: relative;
        padding-bottom: 15px;
    }
    
    h2::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 3px;
        background: linear-gradient(90deg, #2a5298, #1e3c72);
        border-radius: 3px;
    }
    
    h4 {
        color: #2a5298;
        margin-bottom: 20px;
        font-weight: 600;
    }

    /* Section styling */
    .section {
        background-color: #ffffff;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .section:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }
    
    .section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 5px;
        height: 100%;
        background: linear-gradient(to bottom, #2a5298, #1e3c72);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .section:hover::before {
        opacity: 1;
    }
    
    /* Order details styling */
    .border-bottom {
        border-color: #e9ecef !important;
        padding: 15px 0;
        transition: all 0.3s ease;
    }
    
    .border-bottom:hover {
        background-color: #f8f9fa;
        padding-left: 10px;
        border-color: #2a5298 !important;
    }
    
    /* Billing address section */
    .billing-address-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    #address-list {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 10px;
        margin-bottom: 20px;
    }
    
    #address-list::-webkit-scrollbar {
        width: 8px;
    }
    
    #address-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    #address-list::-webkit-scrollbar-thumb {
        background: #2a5298;
        border-radius: 10px;
    }
    
    #address-list::-webkit-scrollbar-thumb:hover {
        background: #1e3c72;
    }
    
    /* Address card styling */
    .address-card {
        background-color: #ffffff;
        border: 2px solid #e0e0e0 !important;
        border-radius: 12px !important;
        padding: 20px !important;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .address-card:hover {
        border-color: #2a5298 !important;
        box-shadow: 0 5px 15px rgba(42, 82, 152, 0.1);
        transform: translateY(-3px);
    }
    
    .address-radio {
        display: none;
    }
    
    .address-radio + label {
        display: block;
        cursor: pointer;
        position: relative;
        padding-left: 30px;
    }
    
    .address-radio + label:before {
        content: '';
        position: absolute;
        left: 0;
        top: 2px;
        width: 20px;
        height: 20px;
        border: 2px solid #2a5298;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    
    .address-radio:checked + label:after {
        content: '';
        position: absolute;
        left: 5px;
        top: 7px;
        width: 10px;
        height: 10px;
        background: #2a5298;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    
    .address-content {
        margin-top: 15px;
    }
    
    .address-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 15px;
    }
    
    /* Button styling */
    .btn {
        border-radius: 30px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
    }
    
    .btn-primary {
        background: linear-gradient(45deg, #2a5298, #1e3c72);
        box-shadow: 0 4px 15px rgba(42, 82, 152, 0.2);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(42, 82, 152, 0.3);
        background: linear-gradient(45deg, #1e3c72, #2a5298);
    }
    
    .btn-secondary {
        background: #f1f2f6;
        color: #2d3436;
    }
    
    .btn-secondary:hover {
        background: #e4e6eb;
        transform: translateY(-2px);
    }
    
    .btn-danger {
        background: linear-gradient(45deg, #ff4757, #ff6b81);
        box-shadow: 0 4px 15px rgba(255, 71, 87, 0.2);
    }
    
    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 71, 87, 0.3);
    }
    
    .btn-outline-dark {
        border: 2px solid #2a5298;
        color: #2a5298;
        background: transparent;
        font-weight: 600;
        padding: 12px 30px;
        position: relative;
        overflow: hidden;
        z-index: 1;
    }
    
    .btn-outline-dark::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        height: 100%;
        background: linear-gradient(45deg, #2a5298, #1e3c72);
        z-index: -1;
        transition: width 0.3s ease;
    }
    
    .btn-outline-dark:hover {
        color: #fff;
        border-color: transparent;
    }
    
    .btn-outline-dark:hover::before {
        width: 100%;
    }
    
    /* Price text styling */
    .price-text {
        color: #2a5298;
        font-weight: 700;
        font-size: 1.2rem;
    }
    
    /* Total payment styling */
    .total-payment {
        background: linear-gradient(90deg, rgba(42, 82, 152, 0.1), transparent);
        padding: 15px;
        border-radius: 12px;
        text-align: right;
        margin-top: 20px;
        animation: pulse 2s infinite;
    }
    
    /* Animations */
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(42, 82, 152, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(42, 82, 152, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(42, 82, 152, 0);
        }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .container {
            padding: 15px;
        }
        
        .section {
            padding: 15px;
        }
        
        .address-actions {
            flex-direction: column;
        }
        
        .address-actions .btn {
            width: 100%;
            margin-bottom: 5px;
        }
    }
</style>

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Checkout</h2>

    <!-- Order Details Section -->
    <div class="section">
        <h4>Your Order</h4>
        <div>
            {% for item in cart_items %}
                <div class="d-flex justify-content-between border-bottom py-2">
                    <div>
                        <strong>{{ item.product.product_name }}</strong>
                        <small class="text-muted d-block">Quantity: {{ item.quantity }}</small>
                    </div>
                    <div>
                        <span class="price-text">₹{{ item.product.price }}</span>
                        <small class="text-muted d-block">Total: ₹{{ item.total_price }}</small>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="total-payment">
            <h4 class="mb-0">Total Payment: <span class="price-text">₹{{ total_price }}</span></h4>
        </div>
    </div>
    
<!-- Billing Address Section -->
<div class="section">
    <div class="billing-address-title">
        <h4>Select Your Billing Address</h4>
        <a href="{% url 'add_address' %}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus-circle"></i> Add New Address
        </a>
    </div>
    <div id="address-list">
        {% for address in addresses %}
            <div class="address-card">
                <input type="radio" name="selected_address" id="address-{{ address.id }}" value="{{ address.id }}" class="address-radio">
                <label for="address-{{ address.id }}" class="font-weight-bold">Select this address</label>
                <div class="address-content">
                    <p class="mb-1"><strong>{{ address.house_name }}</strong></p>
                    <p class="mb-1">{{ address.postal_address }}</p>
                    <p class="mb-1">{{ address.city }}, {{ address.district }}, {{ address.state }}</p>
                    <p class="mb-0">Pincode: {{ address.pincode }}</p>
                </div>
                <div class="address-actions">
                    <button class="btn btn-secondary btn-sm" onclick="deselectAddress('{{ address.id }}')">Deselect</button>
                    <button class="btn btn-danger btn-sm" onclick="removeAddress('{{ address.id }}')">Remove</button>
                </div>
            </div>
        {% empty %}
            <div class="text-center py-4">
                <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                <p>No addresses found. Please add a new address.</p>
            </div>
        {% endfor %}
    </div>
</div>

    <!-- Product Details Section -->
    <div class="section">
        <h4>Product Details</h4>
        <div>
            {% for item in cart_items %}
                <div class="d-flex justify-content-between border-bottom py-2">
                    <div>
                        <strong>{{ item.product.product_name }}</strong>
                        <small class="text-muted d-block">Quantity: {{ item.quantity }}</small>
                    </div>
                    <div>
                        <span class="price-text">₹{{ item.product.price }}</span>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Checkout Button Section -->
    <div class="section text-center">
        <button id="rzp-button1" class="btn btn-outline-dark btn-lg">
            <i class="fas fa-credit-card me-2"></i> Proceed to Payment
        </button>
    </div>
</div>
{% load custom_filters %}

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    var options = {
        "key": "rzp_test_7MkWbHUlMslHd2", // Your Razorpay Test Key ID
        "amount": "{{ total_price|multiply:100 }}", // Multiply total_price by 100 to convert to paise
        "currency": "INR",
        "description": "Acme Corp",
        "image": "https://example.com/image/rzp.jpg", // Ensure to use a valid URL
        "prefill": {
            "email": "jeeljpaul2025@mca.ajce.in",
            "contact": "9072613031" // Keep this as a string
        },
        "config": {
            "display": {
                "blocks": {
                    "utib": { // Name for Axis block
                        "name": "Pay Using Axis Bank",
                        "instruments": [
                            {
                                "method": "card",
                                "issuers": ["UTIB"]
                            },
                            {
                                "method": "netbanking",
                                "banks": ["UTIB"]
                            }
                        ]
                    },
                    "other": { // Name for other block
                        "name": "Other Payment Methods",
                        "instruments": [
                            {
                                "method": "card",
                                "issuers": ["ICIC", "HDFC", "SBI", "AXIS"]
                            },
                            {
                                "method": "netbanking"
                            },
                            {
                                "method": "upi", // Enable UPI payments
                                "issuers": ["googlepay", "paytm", "phonepe"] // Add specific UPI apps
                            }
                        ]
                    }
                },
                "hide": [],
                "sequence": ["block.utib", "block.other"],
                "preferences": {
                    "show_default_blocks": true // Show default blocks for other payment methods
                }
            }
        },
        "handler": function (response) {
            alert("Payment successful! Payment ID: " + response.razorpay_payment_id);

            // Ensure an address is selected before proceeding
            const selectedAddress = document.querySelector('input[name="selected_address"]:checked');
            if (!selectedAddress) {
                alert("Please select an address.");
                return; // Exit the function if no address is selected
            }

            // Prepare payment data to send to the server
            const paymentData = {
                payment_id: response.razorpay_payment_id,
                address_id: selectedAddress.value,
                total_price: "{{ total_price|floatformat:2 }}"  // Ensure total price is correctly rendered
            };

            // Send payment data to server for processing
            fetch('/payment_success/', {  // Your server endpoint to handle the payment
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')  // Send CSRF token for security
                },
                body: JSON.stringify(paymentData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log(data);
                    alert("Order placed successfully!");
                    // Redirect or update the page to show success
                    window.location.href = '/order_history/';
                } else {
                    alert("Failed to place the order.");
                }
            })
            .catch(error => console.error('Error:', error));
        },
        "modal": {
            "ondismiss": function () {
                if (confirm("Are you sure you want to close the form?")) {
                    console.log("Checkout form closed by the user");
                } else {
                    console.log("Complete the Payment");
                }
            }
        }
    };

    var rzp1 = new Razorpay(options);

    document.getElementById('rzp-button1').onclick = function (e) {
        const selectedAddress = document.querySelector('input[name="selected_address"]:checked');
        if (!selectedAddress) {
            alert("Please select an address before proceeding to payment.");
            return;
        }
        
        rzp1.open();
        e.preventDefault(); // Prevent default button action
    };
</script>

<script>
    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Check if this cookie string begins with the name we want
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Deselect function to uncheck the selected address radio button
    function deselectAddress(addressId) {
        const addressRadio = document.getElementById('address-' + addressId);
        if (addressRadio) {
            addressRadio.checked = false;
        }
    }

    // Remove function to delete an address
    function removeAddress(addressId) {
        if (confirm("Are you sure you want to delete this address?")) {
            // AJAX request to remove the address
            fetch(`/remove_address/${addressId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')  // CSRF token
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Address removed successfully.');
                    location.reload();  // Refresh page to update address list
                } else {
                    alert('Failed to remove address.');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }

    // JavaScript function to validate the input field for alphabets and spaces only
    function validateCity(input) {
        // Regular expression to allow only alphabets and spaces
        input.value = input.value.replace(/[^a-zA-Z\s]/g, '');
    }

    function validateDistrict(input) {
        // Regular expression to allow only alphabets and spaces
        input.value = input.value.replace(/[^a-zA-Z\s]/g, '');
    }

    function validateState(input) {
        // Regular expression to allow only alphabets and spaces
        input.value = input.value.replace(/[^a-zA-Z\s]/g, '');
    }

    function validatePincode(input) {
        // Regular expression to allow only digits
        input.value = input.value.replace(/[^0-9]/g, '');
    }
</script>
{% endblock %}